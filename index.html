<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Looops</title>
  </head>

  <body>
    <script src="elm.js"></script>
    <script>
      var dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
      function randomDirection() {
        return dirs[Math.floor(Math.random() * 4)];
      }

      function makeLoop(minLength, maxLength) {
        var pt = [0, 0];
        var deltas = [];
        while (deltas.length < minLength || pt[0] != 0 || pt[1] != 0) {
          if (deltas.length >= maxLength) {
            return makeLoop(minLength, maxLength);
          }
          var dir = randomDirection();
          pt = [pt[0] + dir[0], pt[1] + dir[1]];
          deltas.push(dir);
        }
        return deltas;
      }

      var app = Elm.Main.init();

      app.ports.requestLoops.subscribe(function(args) {
        var loops = [];

        for (var i = 0; i < args.count; i++) {
          deltas = makeLoop(args.minLength, args.maxLength);
          center = [
            (Math.random() * args.width) | 0,
            (Math.random() * args.height) | 0
          ];
          // center = [args.width / 2 | 0, args.height / 2 | 0]
          hue = Math.random() * 360;

          loops.push([deltas, center, hue]);
        }

        app.ports.getLoops.send(loops);
      });

      function download() {
        // https://stackoverflow.com/questions/23218174/how-do-i-save-export-an-svg-file-after-creating-an-svg-with-d3-js-ie-safari-an
        var svgData = document.getElementsByTagName("svg")[0].outerHTML;
        if (
          !svgData.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)
        ) {
          svgData = svgData.replace(
            /^<svg/,
            '<svg xmlns="http://www.w3.org/2000/svg"'
          );
        }
        if (!svgData.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
          svgData = svgData.replace(
            /^<svg/,
            '<svg xmlns:xlink="http://www.w3.org/1999/xlink"'
          );
        }

        //add xml declaration
        svgData = '<?xml version="1.0" standalone="no"?>\r\n' + svgData;

        var svgBlob = new Blob([svgData], {
          type: "image/svg+xml;charset=utf-8"
        });
        var svgUrl = URL.createObjectURL(svgBlob);
        var downloadLink = document.createElement("a");
        downloadLink.href = svgUrl;
        downloadLink.download = "newesttree.svg";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }
    </script>
  </body>
</html>
