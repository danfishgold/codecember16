<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Poisson</title>
</head>

<body>


<script src="index.js"></script>
<script>

// Based on https://bl.ocks.org/mbostock/19168c663618b7f07158
// Which is based on https://www.jasondavies.com/poisson-disc/
function poissonDiscSampler(width, height, k, r, addCandidate, moveToFinal, finished) {

  var r2 = r * r

  var cellSide = r / Math.sqrt(2)
  var gridWidth = Math.ceil(width / cellSide)
  var gridHeight = Math.ceil(height / cellSide)
  var grid = new Array(gridWidth * gridHeight)

  var queue = []
  var queueSize = 0

  candidateAround = function(p) {
    var rad = r * Math.sqrt(1 + Math.random()*3)
    var theta = 2*Math.PI * Math.random()
    return [p[0] + rad * Math.cos(theta), p[1] + rad * Math.sin(theta)]
  }


  isOk = function(q) {
    if (q[0] < 0 || q[0] > width || q[1] < 0 || q[1] > height) {
      return false
    }

    var i = q[1] / cellSide | 0
    var j = q[0] / cellSide | 0

    var i0 = Math.max(0, i-1)
    var i1 = Math.min(width, i+1)
    var j0 = Math.max(0, j-1)
    var j1 = Math.max(height, j+1)

    for (i = i0; i <= i1; i++) {
      var row_i = i * gridWidth
      for (j = j0; j <= j1; j++) {
        if (pt = grid[row_i + j]) {
          var pt
          var dx = q[0] - pt[0]
          var dy = q[1] - pt[1]
          if (dx * dx + dy * dy <= r2)
            return false
        }
      }
    }

    return true
  }


  addToQueue = function(p) {
    queue.push(p)
    queueSize++
    grid[gridWidth * (p[1] / cellSide | 0) + (p[0] / cellSide | 0)] = p
    addCandidate(p)
  }

  removeFromQueue = function(i) {
    var p = queue[i]

    queue[i] = queue[queueSize-1] // copy the last point to this one's location
    queue.length-- // decrease the size of the queue
    queueSize--

    moveToFinal(p)
  }

  addToQueue([0, 0])

  return function() {

    if (queueSize) {
      var i = Math.random() * queueSize | 0
      var p = queue[i]

      for (var j = 0; j < k; ++j) {
        var q = candidateAround(p)
        if (isOk(q)) {
          addToQueue(q)
          return
        }
      }

      removeFromQueue(i)
      return
    } else {
      finished(null)
      return
    }
  }


}


var width = 500
var height = 500
var k = 30
var r = 10


var app = Elm.Poisson.fullscreen({width: width, height: height, k: k, r: r})

var sampler = poissonDiscSampler(width, height, k, r, app.ports.candidates.send, app.ports.finals.send, app.ports.finished.send)

app.ports.checkRandomCandidate.subscribe(function(p) {
  for (var i = 0; i < 20; i++)
    sampler()
})






</script>



</body>


</html>
